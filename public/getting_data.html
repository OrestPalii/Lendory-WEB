<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parsing firebase</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/live/3.1/firebase.js"></script>
    <script src="serverlogic.js"></script>
</head>
<body id="getting_body" >
    
    <div id="tbody1">
        
    </div>
    <script>
        
    </script>
    <script type="module">
        var tbody = document.getElementById("tbody1");
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";

    const firebaseConfig = {
    apiKey: "AIzaSyCPf1_9AlKYGFEF0nHn3c1IGH8BecVSeig",
    authDomain: "lendory-b5d8b.firebaseapp.com",
    databaseURL: "https://lendory-b5d8b-default-rtdb.firebaseio.com",
    projectId: "lendory-b5d8b",
    storageBucket: "lendory-b5d8b.appspot.com",
    messagingSenderId: "759222136421",
    appId: "1:759222136421:web:8c38d800bca06e1e6ce08c"
    };

    const app = initializeApp(firebaseConfig);

    import {getDatabase, ref, get, set, child, update, remove}
        from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";
    import {getStorage, ref as sRef, uploadBytesResumable, getDownloadURL} 
        from "https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js";
        
    const db = getDatabase();
    window.onload = GetAllDataOnce; 
        function AddItemToTable(position, name, loc, descript, img_num, hashnumber){
            let big_div = document.createElement("div");
            let left_description = document.createElement("div");
            let right_description = document.createElement("div");
            let image = document.createElement("img");
            let like_image_back = document.createElement("img");
            let like_image = document.createElement("img");
            let other_image = document.createElement("img");
            let other_image_back = document.createElement("img");
            let count_photo = document.createElement("p");
            let td1 = document.createElement("p");
            let td2 = document.createElement("p");
            let td3 = document.createElement("p");
            let more = document.createElement("a");



            big_div.setAttribute(
                'style',
                'position: relative; text-align: center; margin-top: 30px; margin-left: 30px; width: 400px; height: 453px; background-color: rgb(255, 255, 255); border-radius: 35px; z-index:10;'
            )

            left_description.setAttribute(
                'style', 
                'text-align: center; margin-left: 28px; padding: 10px; margin-top: 10px; float: left; position: relative;'
            )

            right_description.setAttribute(
                'style', 
                'text-align: left; margin-top: -55px; position: relative;padding-top: 70px;padding-left: 15px;float: right;color: #fff;background: url(https://firebasestorage.googleapis.com/v0/b/lendory-b5d8b.appspot.com/o/gradient1.jpg?alt=media&token=903b7447-ad43-44d3-b559-4a66f7c958e6) no-repeat;background-size: cover;width: 230.73px;height: 232.41px;border-radius: 35px;z-index: 1;'
            )

            image.setAttribute(
                'style',
                'float: right;border-radius: 30px;width: 400.17px;height: 276.57px;position: relative;object-fit: cover;z-index: 10; '
            )
            like_image.setAttribute(
                'style',
                'right: 0; margin-top: 220px; margin-right: 16px; width: 40px;height: 40px;position: absolute;z-index: 15;'
            )
            like_image_back.setAttribute(
                'style',
                'right: 0; margin-top: 217px; border-radius: 10px; background-color: white; margin-right: 13px; width: 46px;height: 46px;position: absolute;z-index: 15;'
            )

            other_image.setAttribute(
                'style',
                'margin-left: -15px;margin-top: 2px; width: 122.18px;height: 117.09px;object-fit: cover;border-radius: 20px;filter: grayscale(100%);'
            )

            other_image_back.setAttribute(
                'style',
                'margin-left: -122px;margin-top: 2px; width: 122.18px;height: 117.09px;object-fit: cover;border-radius: 20px; background-color:black; opacity: 0.5'
            )

            count_photo.setAttribute(
                'style',
                'position: absolute;margin-top: -125px;margin-left: 8px;font-size: 80px;color: #fff;  '
            )

            more.setAttribute(
                'style',
                'padding-left: 5px;text-transform: uppercase;margin-bottom: 140px; color: #CF89DB;font-weight: 500;font-size: 19px;letter-spacing: 0.1em;  '
            )

            
            td1.innerHTML = name;
            td2.innerHTML = loc;
            td3.innerHTML = descript;
            count_photo.innerHTML = '+3'
            more.innerHTML = 'Більше'
            image.src = img_num;
            
            var flag = false;
            for(let i = 0; i < likedByU.length; i++){
                if(likedByU[i] == hashnumber)  
                    flag = true;      
            }
            if(flag)
                like_image.src = "liked_heart.png"
            else
                like_image.src = "heart.png"
            more.href = 'advertreview.html#' + hashnumber; 

            big_div.appendChild(like_image_back);
            big_div.appendChild(like_image);
            big_div.appendChild(image);
            like_image.onclick = function(){
                addLiked(like_image, hashnumber, flag);
            }
            // info_on_photo.appendChild(label_location);
            // info_on_photo.appendChild(label_price);
            // big_div.appendChild(info_on_photo);
            
            left_description.appendChild(other_image);
            left_description.appendChild(other_image_back);
            left_description.appendChild(count_photo);
            right_description.appendChild(td1);
            right_description.appendChild(td2);
            right_description.appendChild(td3);
            big_div.appendChild(left_description);
            big_div.appendChild(right_description);
            big_div.appendChild(more);
            
            
            tbody.appendChild(big_div);
            
        }

        function AddAllItemsToTable(TheAdvertisement){
            tbody.innerHTML="";
            var position = 0;
            TheAdvertisement.forEach(element => {
                AddItemToTable(position, element.name, element.location, element.description, element.images[0], element.hashnumber);
                position++;
            });
        }

        var likedByU = [];

        function GetAllDataOnce(){
            const dbRef = ref(db);
            get(child(dbRef, "advertisement"))
            .then((snapshot)=>{
                var advertisements = [];
                snapshot.forEach(childSnapshot =>{
                    advertisements.push(childSnapshot.val());
                });
                getUsername();
                get(child(dbRef, "profiles/" + currentUser.phonenumber + "/liked"))
                    .then((snapshot)=>{
                    snapshot.forEach(childSnapshot =>{
                     likedByU.push(childSnapshot.val());
                    });
                    AddAllItemsToTable(advertisements); 
                }) 
            })
        
        }
        function addLiked(image, numb, flag){
            getUsername();
            const dbRef = ref(db);
            var curpos = 1230102301230;
            likedByU = [];
            get(child(dbRef, "profiles/" + currentUser.phonenumber + "/liked"))
            .then((snapshot)=>{
                snapshot.forEach(childSnapshot =>{
                    likedByU.push(childSnapshot.val());
                    if(childSnapshot.val() == numb)
                        curpos = likedByU.length-1;
                });
                if(curpos == 1230102301230){
                    set(ref(db, "profiles/" + currentUser.phonenumber + "/liked/" + likedByU.length),
                        numb   
                    ); 
                    image.src = "liked_heart.png";
                }else{
                    set(ref(db, "profiles/" + currentUser.phonenumber + "/liked/" + curpos),
                        null   
                    );   
                    image.src = "heart.png";  
                }
            })      
        }
    </script>
</body>
</html>
